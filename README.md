# MUBD-DecoyMaker<sup>syn</sup>: Making Synthetic Maximal Unbiased Benchmarking Datasets via Deep Reinforcement Learning

[![Zenodo Badge](https://zenodo.org/badge/DOI/10.5281/zenodo.7861685.svg)](https://doi.org/10.5281/zenodo.7861685)

## Introduction

![Figure from manuscript](figures/abstract.png)
MUBD-DecoyMaker<sup>syn</sup> is a brand-new computational software to make synthetic Maximal Unbiased Benchmarking Datasets (MUBD<sup>syn</sup>) for in silico screening. Compared with our earlier two versions, i.e. [MUBD-DECOYMAKER](https://github.com/jwxia2014/MUBD-DECOYMAKER) (Pipeline Pilot-based version, or MUBD-DecoyMaker 1.0) and [MUBD-DecoyMaker 2.0](https://github.com/jwxia2014/MUBD-DecoyMaker2.0), MUBD-DecoyMaker<sup>syn</sup> has two noteworthy features:

1. Virtual molecules generated by recurrent neural netwrok (RNN)-based molecular generator with reinforcement learning (RL), instead of chemical library molecules, constitue the unbiased decoy set (UDS) component of MUBD. 

2. The criteria (or rule) for an ideal decoy previously defined in the earlier versions are integrated into a new scoring function for RL to fine-tune the generator.


Below is how to make MUBD<sup>syn</sup> with MUBD-DecoyMaker<sup>syn</sup>.

## Requirements

As [REINVENT](https://github.com/MolecularAI/Reinvent) is used to make virtual decoys of MUBD<sup>syn</sup>, users are required to install this tool as instructed (this repository holds the version 3.2 of REINVENT, *Copyright 2021 Atanas Patronov*, licensed under the Apache 2.0 license). The corresponding `conda` environment named `reinvent` is created for virtual decoy generation. Please note we also  modified and use the source code from [reinvent-chemistry](https://github.com/MolecularAI/reinvent-chemistry) and [reinvent-scoring](https://github.com/MolecularAI/reinvent-scoring), *Copyright 2021 Atanas Patronov*, licensed under the Apache 2.0 license, here in order to include our scoring functions specific for MUBD<sup>syn</sup>. Another `conda` environment named `MUBD` is also created for preprocessing and postprocessing.

1) Clone this repository and navigate to it:
```bash
$ git clone https://github.com/Sooooooap/MUBDsyn.git
$ cd MUBDsyn
```
2) Create the `conda` environment called `reinvent`:
```bash
$ cd Reinvent
$ conda env create -f reinvent.yml
```
3) Create the `conda` environment called `MUBD`:
```bash
$ cd ../MUBD
$ conda env create -f MUBD.yml
```

## Usage

`PR_agonist` from [NRLiSt BDB](http://nrlist.drugdesign.fr/) is used as a test case to demonstrate how to make MUBD<sup>syn</sup> with MUBD-DecoyMaker<sup>syn</sup>. All the test files are in the directory of `./resources/case`. 

### Build the unbiased ligand set (ULS<sup>syn</sup>)
Run `build_uls.py` to process the raw ligand set. This script takes the raw ligands in SMILES representation as input and puts out the unbiased ligand set (`Diverse_ligands.csv`). Four more files regarding ligand properties, i.e. `Diverse_ligands_PS.csv`, `Diverse_ligands_PS_maxmin.csv`, `Diverse_ligands_sims_maxmin.txt` and `Diverse_ligands_len.txt`, are also generated and stored in the directory of `./MUBD/output/ULS/`.

IMPORTANT: Ligand curation, including molecule standardization, salt removal and protonization at a specific range of pH (implemented by [Dimorphite-DL](https://github.com/Sulstice/dimorphite_dl)), is required if the ligands are not curated. For ligand curation, we provide the `--curate` option for `build_uls.py`.
```bash
$ cd ./MUBD
$ conda activate MUBD
(MUBD) $ python build_uls.py --i ../resources/case/PR_agonists.csv --curate
```

### Generate the potential decoy set

`mk_config.py` writes out the configurations for the generation of MUBD<sup>syn</sup> virtual decoys. We provide `gen_decoys.sh` to iterate over all the ligands and set the configurations specific for each of them. Notice that this step may take more than ten hours for this case with the default configuration.
```bash
$ chmod +x ./gen_decoys.sh
$ conda activate reinvent
(reinvent) $ ./gen_decoys.sh
```

### Build the unbiased decoy set (UDS<sup>syn</sup>)
The file within the directory of `./MUBD/output/UDS/auto_train/ligand_*/results/scaffold_memory.csv` contains the potential decoy set specific for the `ligand_*`. The potential decoy set is refined by SMILES curation and structural clustering (script: `curating_clustering.py`). Then the unbiased decoys for each ligand were annotated with the properties and merged  (script: `merge_decoys.py`) to consitute the final decoy set. We provide `build_uds.sh` to automatically run the above mentioned scripts.
```bash
$ chmod +x ./build_uds.sh
$ conda activate MUBD
(MUBD) $ ./build_uds.sh
```
MUBD<sup>syn</sup> is stored in the root directory, i.e. `MUBDsyn_ULS.csv` and `MUBDsyn_UDS.csv`.

## Validation
Users can perform a quick validation on the generated MUBD<sup>syn</sup> with four basic metrics. We provide `./MUBD/validate.py` to perform the validation and store the  results in the directory of `./MUBD/validation/results/`:
```bash
$ cd ./MUBD
$ conda activate MUBD
(MUBD) $ python validate.py
```
The comprehensive validations performed in the paper can be reproduced according to the scripits and notebooks provided in the directory of `./resources/validation_paper/`. All relevant datasets are available at [Zenodo](https://zenodo.org/record/7861685#.ZEe3w3ZBxPa).

|            Validaiton                 | Notebooks/Scripts                     | Datasets         |
|:-------------------------------------:|---------------------------------------|------------------|
|                  Internal Validation  | int_val_figs.ipynb<br>int_val_tabs.ipynb | datasets_int_val |
| External Validation<br>(classical_VS) | ext_val_classical_VS_figs.ipynb<br>ext_val_classical_VS_tabs.ipynb | datasets_ext_val_classical_VS |
| External Validation<br>(ML_VS*)        | ext_val_ML_VS_AVEbias.py<br>ext_val_ML_VS_AVEbias_plt_MUBDreal.ipynb<br>ext_val_ML_VS_AVEbias_plt_MUBDsyn.ipynb | datasets_ext_val_ML_VS |
*Benchmark results of three ML models are available at [ext_val_ML_VS_benchmark](resources/validation_paper/external_validation/ML_VS/ext_val_ML_VS_benchmark).

## Acknowledgements
We thank the authors of REINVENT [REINVENT 2.0: An AI Tool for De Novo Drug Design](https://pubs.acs.org/doi/10.1021/acs.jcim.0c00915) for making [REINVENT](https://github.com/MolecularAI/Reinvent) open to the community. Our work is based on this computational tool. Please consider citing their work if you use MUBD-DecoyMaker<sup>syn</sup> in your research.

We also appreciate the developers of [Dimorphite-DL](https://github.com/Sulstice/dimorphite_dl). We use that computational tool to protonate raw actives. It is highly recommended to cite their publication [Dimorphite-DL: an open-source program for enumerating the ionization states of drug-like small molecules](https://jcheminf.biomedcentral.com/articles/10.1186/s13321-019-0336-9), if you use it in your work. 
